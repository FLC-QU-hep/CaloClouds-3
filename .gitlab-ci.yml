# GitLab Continuous Integration configuration for the repository.

# "Global" build stages.
stages:
  - build
  - test

# Set the behaviour of the CI build.
variables:
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: recursive
  # Change pip's cache directory to be inside the project directory since we can only cache local items.
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Set up caching pip packages
default:
  image: python:3.11
  cache:                      # Pip's cache doesn't store the python packages
    paths:                    # https://pip.pypa.io/en/stable/topics/caching/
      - .cache/pip
  before_script:
    - echo " PIP_CACHE_DIR = "$PIP_CACHE_DIR
    - ls $PIP_CACHE_DIR
    - python -V               # Print out python version for debugging
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - echo " PIP_CACHE_DIR = "$PIP_CACHE_DIR
    - ls $PIP_CACHE_DIR

# Setup for building the code
build:
  stage: build
  script:
    - echo " PIP_CACHE_DIR = "$PIP_CACHE_DIR
    - ls $PIP_CACHE_DIR
    - echo "No real build, just python modules to get."
    - pip install -r requirements.txt
    - pip install pytest
    - echo "Python modules installed."
    - echo " PIP_CACHE_DIR = "$PIP_CACHE_DIR
    - ls $PIP_CACHE_DIR

# run the regression tests
pytest:
  stage: test
  only:
    - main
    - henry_dev_newTests
    - merge_requests
  script:
    - echo " PIP_CACHE_DIR = "$PIP_CACHE_DIR
    - ls $PIP_CACHE_DIR
    - echo "Running pytests"
    - pytest test/
      

